uuid: c328a649-4700-47b2-b43a-7d93da4c1d2e
projectId: relaycode-tui
createdAt: '2025-09-25T03:20:15.765Z'
gitCommitMsg: >-
  fix(review): Overhaul review screen UI and navigation

  This commit addresses multiple TypeScript errors and implements a significant
  set of UI/UX enhancements on the Review Screen based on user feedback.

  - Fixes all `no-undef` and unused variable errors in `ReviewScreen.tsx` by
  correctly managing props from the `useReviewScreen` hook. - Implements a
  unified navigation model, allowing seamless up/down arrow key navigation
  through all sections (Prompt, Reasoning, Scripts, Files). - Enhances visual
  clarity by adding color-coding to file types (ADD, DEL, REN) and diff
  statistics (+/- lines) in the file list. - Updates the header to display total
  transaction statistics for better at-a-glance context, rather than only
  approved file stats. - Makes the "Bulk Repair" modal interactive, allowing
  users to navigate options with arrow keys, and adds a corresponding debug menu
  state. - Updates the `review-screen.readme.md` to reflect all design and
  interaction changes.
promptSummary: >-
  The user requested fixes for TypeScript errors and several UI/UX improvements
  on the review screen, including better navigation, color coding, clearer
  stats, and an interactive bulk repair modal.
reasoning:
  - >-
    This is an excellent set of improvements. I've addressed the TypeScript
    errors and implemented the requested UI/UX enhancements across the review
    screen workflow. Here is the detailed breakdown of the changes.
  - '### Part 1: Fixing Errors and Refactoring State'
  - >-
    I'll start by correcting the TypeScript errors, which involves exporting a
    type, cleaning up the statistics calculation in the `useReviewScreen` hook,
    and then updating the `ReviewScreen` component to correctly consume the
    hook's output.
  - '### Part 2: State Management and Debugging'
  - >-
    Next, I'll update the `review` store to handle navigation within the bulk
    repair modal and enhance the debug menu to test this new state.
  - '### Part 3: Documentation Update'
  - >-
    Finally, I'll synchronize the `review-screen.readme.md` with the new design,
    ensuring the documentation accurately reflects the improved navigation flow,
    statistics display, and modal interactivity.
  - >-
    -   **Behavior:** The header clearly indicates `MULTIPLE PATCHES FAILED`.
    The footer presents both single-file `(T)` and `(Shift+T)` bulk repair
    options.
  - '@@ -69,17 +69,17 @@'
  - ▲ relaycode review
  - >-
    ──────────────────────────────────────────────────────────────────────────────
  - 'e4a7c112 · refactor: rename core utility function'
  - '-  (0/0) · 0/3 Files · 0.6s · Scripts: SKIPPED · MULTIPLE PATCHES FAILED'
  - >-
    +  (+18/-5) · 3 Files · 0/3 Approved · Scripts: SKIPPED · MULTIPLE PATCHES
    FAILED
  - (P)rompt ▸ Rename the `calculateChanges` utility to `computeDelta`...
  - (R)easoning (2 steps) ▸ 1. Renamed the function in its definition file...
  - >-
    ──────────────────────────────────────────────────────────────────────────────
  - FILES
  - '-> [✗] MOD src/core/transaction.ts (+18/-5) [replace]'
  - +> [✗] MOD src/core/transaction.ts (+18/-5) [replace]
  - '[!] FAILED src/utils/logger.ts    (Hunk #1 failed to apply)'
  - '[!] FAILED src/commands/apply.ts   (Context mismatch at line 92)'
  - >-
    ──────────────────────────────────────────────────────────────────────────────
  - '- (↑↓) Nav · (Spc) Toggle · (D)iff · (Shift+R) Reject All · (Esc) Back'
  - + (↑↓) Nav · (Spc) Toggle · (D)iff · (Shift+R) Reject All · (Q)uit
  - >-
    -   **Behavior:** New, expandable sections appear for each post-application
    script, providing an at-a-glance summary of their results (`✓`/`✗`).
  - '@@ -116,7 +116,7 @@'
  - ▲ relaycode review
  - >-
    ──────────────────────────────────────────────────────────────────────────────
  - '4b9d8f03 · refactor: simplify clipboard logic'
  - '-  (+22/-11) · 2 Files · 3.9s'
  - +  (+22/-11) · 2 Files · 2/2 Approved · 3.9s
  - (P)rompt ▸ Simplify the clipboard logic using an external library...
  - (R)easoning (3 steps) ▸ 1. Added clipboardy dependency...
  - '@@ -181,15 +181,15 @@'
  - How would you like to proceed?
  - '-> (1) Copy Bulk Re-apply Prompt (for single-shot AI)'
  - '-  (2) Bulk Change Strategy & Re-apply'
  - +  (1) Copy Bulk Re-apply Prompt (for single-shot AI)
  - +> (2) Bulk Change Strategy & Re-apply
  - (3) Handoff to External Agent
  - (4) Bulk Abandon All Failed Files
  - (Esc) Cancel
  - >-
    ──────────────────────────────────────────────────────────────────────────────
  - '- Choose an option [1-4, Esc]:'
  - + (↑↓) Nav · (Enter) Select · [1-4, Esc] Hotkeys
  - >-
    These changes collectively address the user's feedback, resolving the
    technical errors and significantly improving the usability and clarity of
    the review screen.
operations:
  - type: write
    path: src/hooks/useReviewScreen.tsx
    content: >+
      --- src/hooks/useReviewScreen.tsx

      +++ src/hooks/useReviewScreen.tsx

      @@ -5,7 +5,7 @@
       import { useTransactionStore, selectSelectedTransaction } from '../stores/transaction.store';
       import type { FileItem } from '../types/domain.types';
       
      -type NavigableItem =

      +export type NavigableItem =
           | { type: 'prompt' }
           | { type: 'reasoning' }
           | { type: 'script'; id: string }
      @@ -37,16 +37,12 @@
           const fileReviewStates = useReviewStore(s => s.fileReviewStates);
       
           const reviewStats = useMemo(() => {
               const approvedFiles = files.filter(f => fileReviewStates.get(f.id)?.status === 'APPROVED');
               return {
      -            totalFiles: files.length,
                   totalLinesAdded: files.reduce((sum, f) => sum + f.linesAdded, 0),
                   totalLinesRemoved: files.reduce((sum, f) => sum + f.linesRemoved, 0),
      -            numFiles: files.length,

      +            totalFiles: files.length,
                   approvedFilesCount: approvedFiles.length,
      -            approvedLinesAdded: approvedFiles.reduce((sum, f) => sum +
      f.linesAdded, 0),

      -            approvedLinesRemoved: approvedFiles.reduce((sum, f) => sum +
      f.linesRemoved, 0),
               };
           }, [files, fileReviewStates]);
       

    patchStrategy: standard-diff
  - type: write
    path: src/components/ReviewScreen.tsx
    content: >+
      --- src/components/ReviewScreen.tsx

      +++ src/components/ReviewScreen.tsx

      @@ -3,7 +3,7 @@
       import DiffScreen from './DiffScreen';
       import ReasonScreen from './ReasonScreen';
       import type { ScriptResult, FileItem, FileChangeType } from '../types/domain.types';
      -import { useReviewScreen } from '../hooks/useReviewScreen';

      +import { useReviewScreen, type NavigableItem } from
      '../hooks/useReviewScreen';
       
       // --- Sub-components ---
       
      @@ -23,10 +23,19 @@
               case 'AWAITING': icon = '[●]'; iconColor = 'yellow'; break;
               case 'RE_APPLYING': icon = '[●]'; iconColor = 'cyan'; break;
           }
       
      -    const diffStats =
      <Text>(+{file.linesAdded}/-{file.linesRemoved})</Text>;

      +    const typeColor = (type: FileChangeType) => {

      +        switch (type) {

      +            case 'ADD': return 'green';

      +            case 'DEL': return 'red';

      +            case 'REN': return 'yellow';

      +            default: return 'white';

      +        }

      +    };

      +

      +    const diffStats = <Text>(+<Text
      color="green">{file.linesAdded}</Text>/-<Text
      color="red">{file.linesRemoved}</Text>)</Text>;
           const strategy = file.strategy === 'standard-diff' ? 'diff' : file.strategy;
           const prefix = isFocused ? '> ' : '  ';
           const colorProps = isFocused ? { bold: true, color: 'cyan' } : {};
       
      @@ -60,8 +69,9 @@
       
           return (
               <Box>
                   <Text {...colorProps}>
      -                {prefix}<Text color={iconColor}>{icon}</Text> {file.type}
      {file.path} {diffStats} [{strategy}]

      +                {prefix}<Text color={iconColor}>{icon}</Text>
      {file.type}{' '}

      +                <Text color={typeColor(file.type)}>{file.path}</Text>{'
      '}

      +                {diffStats} [{strategy}]
                   </Text>
               </Box>
           );
      @@ -107,13 +117,13 @@
               reasoningScrollIndex,
               scriptErrorIndex,
               fileReviewStates,
      -        numFiles,

      +        totalFiles,
               approvedFilesCount,
               totalLinesAdded,
               totalLinesRemoved,
      -        approvedLinesAdded,
               selectedBulkRepairOptionIndex,
      +        navigableItems,
           } = useReviewScreen();
       
           if (!transaction) {
      @@ -147,7 +157,7 @@
               }
               
               if (bodyView === 'diff') {
      -            const currentItem = navigableItems[selectedItemIndex];

      +            const currentItem = navigableItems[selectedItemIndex];
                   const selectedFile = currentItem?.type === 'file' ? files.find(f => f.id === currentItem.id) : undefined;
                   if (!selectedFile) return null;
                   return (
      @@ -160,11 +170,11 @@
               }
       
               if (bodyView === 'script_output') {
      -             const currentItem = navigableItems[selectedItemIndex];

      -             const scriptIndex = currentItem?.type === 'script' ?
      navigableItems.filter(i => i.type === 'script').findIndex(i => i.id ===
      currentItem.id) : -1;

      +             const currentItem = navigableItems[selectedItemIndex];

      +             const scriptIndex = currentItem?.type === 'script' ?
      navigableItems.filter((i: NavigableItem) => i.type ===
      'script').findIndex(i => i.type === 'script' && i.id === currentItem.id) :
      -1;
                    const selectedScript = scripts[scriptIndex] || null;
                    if (!selectedScript) return null;
                    
                    const outputLines = selectedScript.output.split('\n');
      @@ -219,7 +229,6 @@
                       '(2) Bulk Change Strategy & Re-apply',
                       '(3) Handoff to External Agent',
                       '(4) Bulk Abandon All Failed Files',
      -                '(Esc) Cancel',
                   ];
       
                   return (
      @@ -236,10 +245,13 @@
                           <Text>How would you like to proceed?</Text>
       
                           <Box flexDirection="column">
      -                        {repairOptions.map((opt, i) => (

      -                            <Text key={i}
      color={selectedBulkRepairOptionIndex === i ? 'cyan' : undefined}>

      -                                {selectedBulkRepairOptionIndex === i ? '>
      ' : '  '}

      -                                {opt}

      -                            </Text>

      -                        ))}

      +                        {repairOptions.map((opt, i) => {

      +                            const isSelected =
      selectedBulkRepairOptionIndex === i;

      +                            return (

      +                                <Text key={i} color={isSelected ? 'cyan'
      : undefined}>

      +                                    {isSelected ? '> ' : '  '}

      +                                    {opt}

      +                                </Text>

      +                            );

      +                        })}
                           </Box>
                       </Box>
                   );
      @@ -265,7 +277,7 @@
               // Main footer
               const actions = ['(↑↓) Nav'];
       
      -        const currentItem = navigableItems[selectedItemIndex];

      +        const currentItem = navigableItems[selectedItemIndex];
               const hasFailedFiles = Array.from(fileReviewStates.values()).some(s => s.status === 'FAILED');
               
               if (currentItem?.type === 'file') {
      @@ -319,8 +331,8 @@
                       <Box flexDirection="column">
                           <Text>{hash} · {message}</Text>
                           <Text>
      -                        (<Text
      color="green">+{totalLinesAdded}</Text>/<Text
      color="red">-{totalLinesRemoved}</Text>) · {numFiles} Files ·
      {approvedFilesCount}/{numFiles} Approved

      +                        (<Text
      color="green">+{totalLinesAdded}</Text>/<Text
      color="red">-{totalLinesRemoved}</Text>) · {totalFiles} Files ·
      {approvedFilesCount}/{totalFiles} Approved
                               {patchStatus === 'PARTIAL_FAILURE' && scripts.length === 0 && <Text> · Scripts: SKIPPED</Text>}
                               {patchStatus === 'PARTIAL_FAILURE' && <Text color="red" bold> · MULTIPLE PATCHES FAILED</Text>}
                           </Text>
      @@ -328,11 +340,11 @@
       
                       <Box flexDirection="column" marginTop={1}>
      -                    <Text color={navigableItems[selectedItemIndex]?.type
      === 'prompt' ? 'cyan' : undefined}>

      -                        {navigableItems[selectedItemIndex]?.type ===
      'prompt' ? '> ' : '  '}

      +                    <Text color={navigableItems[selectedItemIndex]?.type
      === 'prompt' ? 'cyan' : undefined}>

      +                        {navigableItems[selectedItemIndex]?.type ===
      'prompt' ? '> ' : '  '}
                               (P)rompt ▸ {(prompt || '').substring(0, 60)}...
                           </Text>
      -                    <Text color={navigableItems[selectedItemIndex]?.type
      === 'reasoning' ? 'cyan' : undefined}>

      -                        {navigableItems[selectedItemIndex]?.type ===
      'reasoning' ? '> ' : '  '}

      +                    <Text color={navigableItems[selectedItemIndex]?.type
      === 'reasoning' ? 'cyan' : undefined}>

      +                        {navigableItems[selectedItemIndex]?.type ===
      'reasoning' ? '> ' : '  '}
                               (R)easoning ({(reasoning || '').split('\n\n').length} steps) {bodyView === 'reasoning' ? '▾' : '▸'}{' '}
                               {((reasoning || '').split('\n')[0] ?? '').substring(0, 50)}...
                           </Text>
      @@ -342,11 +354,11 @@
                   <Separator />
       
                   {/* Script Results (if any) */}
      -            {scripts.length > 0 && navigableItems.some(i => i.type ===
      'script') && (

      +            {scripts.length > 0 && navigableItems.some((i: NavigableItem)
      => i.type === 'script') && (
                       <>
                           <Box flexDirection="column" marginY={1}>
                               {scripts.map((script: ScriptResult) => (
                                   (() => {
      -                                const navItemIndex =
      navigableItems.findIndex(i => i.type === 'script' && i.id ===
      script.command);

      +                                const navItemIndex =
      navigableItems.findIndex((i: NavigableItem) => i.type === 'script' && i.id
      === script.command);
                                       const isSelected = selectedItemIndex === navItemIndex;
                                       return (
                                           <ScriptItemRow
      @@ -366,7 +378,7 @@
                   <Box flexDirection="column" marginY={1}>
                       <Text bold>FILES</Text>
                       {files.map((file: FileItem) => {
      -                    const navItemIndex = navigableItems.findIndex(i =>
      i.type === 'file' && i.id === file.id);

      +                    const navItemIndex = navigableItems.findIndex((i:
      NavigableItem) => i.type === 'file' && i.id === file.id);
                           const isFocused = selectedItemIndex === navItemIndex;
                           const reviewState = fileReviewStates.get(file.id);
                           return (

    patchStrategy: standard-diff
  - type: write
    path: src/stores/review.store.ts
    content: >+
      --- src/stores/review.store.ts

      +++ src/stores/review.store.ts

      @@ -23,8 +23,10 @@
       
           selectedBulkRepairOptionIndex: number;
       
           actions: {
      -        load: (transactionId: string, initialState?:
      Partial<Pick<ReviewState, 'bodyView'>>) => void;

      +        load: (transactionId: string, initialState?:
      Partial<Pick<ReviewState, 'bodyView' | 'selectedBulkRepairOptionIndex'>>)
      => void;
               moveSelectionUp: (listSize: number) => void;
               moveSelectionDown: (listSize: number) => void;
               expandDiff: () => void;
      @@ -45,6 +47,8 @@
               toggleFileApproval: (fileId: string) => void;
               rejectAllFiles: () => void;
               navigateBulkRepairUp: () => void;
               navigateBulkRepairDown: () => void;
           };
       }
       
      @@ -107,7 +111,7 @@
               approve: () => {
                   const { selectedTransactionId } = useViewStore.getState();
                   if (selectedTransactionId) {
                       useTransactionStore.getState().actions.updateTransactionStatus(selectedTransactionId, 'APPLIED');
      -                useAppStore.getState().actions.showDashboardScreen();
                   }
               },
               startApplySimulation: async (scenario) => {
      @@ -218,6 +222,12 @@
               navigateBulkRepairUp: () => set(state => ({
                   selectedBulkRepairOptionIndex: moveIndex(state.selectedBulkRepairOptionIndex, 'up', 4),
               })),
               navigateBulkRepairDown: () => set(state => ({
                   selectedBulkRepairOptionIndex: moveIndex(state.selectedBulkRepairOptionIndex, 'down', 4),
               })),
           },
       }));

    patchStrategy: standard-diff
  - type: write
    path: src/hooks/useDebugMenu.tsx
    content: >+
      --- src/hooks/useDebugMenu.tsx

      +++ src/hooks/useDebugMenu.tsx

      @@ -124,7 +124,7 @@
               {
                   title: 'Review: Bulk Repair',
                   action: () => {
      -                reviewActions.load('1', { bodyView: 'bulk_repair' });

      +                reviewActions.load('1', { bodyView: 'bulk_repair',
      selectedBulkRepairOptionIndex: 1 });
                       appActions.showReviewScreen();
                   },
               },

    patchStrategy: standard-diff
  - type: write
    path: docs/relaycode-tui/review-screen.readme.md
    content: >-
      --- docs/relaycode-tui/review-screen.readme.md

      +++ docs/relaycode-tui/review-screen.readme.md

      @@ -43,18 +43,18 @@
        ▲ relaycode review
        ──────────────────────────────────────────────────────────────────────────────
         e4a7c112 · refactor: rename core utility function
      -  (+18/-5) · 1/3 Files · 0.6s · Scripts: SKIPPED · MULTIPLE PATCHES
      FAILED

      +  (+18/-5) · 3 Files · 1/3 Approved · Scripts: SKIPPED · MULTIPLE PATCHES
      FAILED
       
        (P)rompt ▸ Rename the `calculateChanges` utility to `computeDelta`...
      - (R)easoning (2 steps) ▸ 1. Renamed the function in its definition
      file...

      + > (R)easoning (2 steps) ▸ 1. Renamed the function in its definition
      file...
        ──────────────────────────────────────────────────────────────────────────────
        FILES
          [✓] MOD src/core/transaction.ts (+18/-5) [replace]
      - > [!] FAILED src/utils/logger.ts    (Hunk #1 failed to apply)

      +   [!] FAILED src/utils/logger.ts    (Hunk #1 failed to apply)
          [!] FAILED src/commands/apply.ts   (Context mismatch at line 92)
       
        ──────────────────────────────────────────────────────────────────────────────
      - (↑↓) Nav · (D)iff · (T)ry Repair · (Shift+T) Bulk Repair · (Shift+R)
      Reject All · (Esc) Back

      + (↑↓) Nav · (Ent) Expand · (T)ry Repair · (Shift+T) Bulk Repair ·
      (Shift+R) Reject All · (Q)uit
       
    patchStrategy: standard-diff
  - type: write
    path: >-
      -   **Behavior:** The UI instantly recalculates. The file icon changes to
      `[✗]`, and the global stats in the navigator (`0/0`, `0/3 Files`) reflect
      the new reality. The footer updates as there are no longer any approved
      files to commit.
    content: >2-
       
      @@ -91,7 +91,7 @@
        ▲ relaycode review
        ──────────────────────────────────────────────────────────────────────────────
         4b9d8f03 · refactor: simplify clipboard logic
      -  (+22/-11) · 2 Files · 3.9s

      +  (+22/-11) · 2 Files · 2/2 Approved · 3.9s
       
        (P)rompt ▸ Simplify the clipboard logic using an external library...
        (R)easoning (3 steps) ▸ 1. Added clipboardy dependency...
      @@ -104,7 +104,7 @@
          [✓] MOD src/utils/shell.ts     (+7/-3)  [diff]
       
        ──────────────────────────────────────────────────────────────────────────────
      - (↑↓) Nav · (Spc) Toggle · (D)iff · (Ent) Expand Details · (C)opy ·
      (A)pprove · (Q)uit

      + (↑↓) Nav · (Spc) Toggle · (D)iff · (Ent) Expand Details · (C)opy ·
      (A)pprove · (Q)uit
       
    patchStrategy: replace
  - type: write
    path: >-
      -   **Behavior:** A blocking modal appears, presenting four distinct
      repair strategies that will apply to all failed files simultaneously.
    content: |2
       
      @@ -203,7 +203,7 @@
        ▲ relaycode review
        ──────────────────────────────────────────────────────────────────────────────
         e4a7c112 · refactor: rename core utility function
      -  (+18/-5) · 1/3 Files · 0.6s · AWAITING PATCH
      +  (+18/-5) · 3 Files · 1/3 Approved · AWAITING PATCH
       
        (P)rompt ▸ Rename the `calculateChanges` utility to `computeDelta`...
        (R)easoning (2 steps) ▸ 1. Renamed the function in its definition file...
      @@ -263,7 +263,7 @@
        ▲ relaycode review
        ──────────────────────────────────────────────────────────────────────────────
         e4a7c112 · refactor: rename core utility function
      -  (+27/-7) · 2/3 Files · 0.6s · PATCH FAILED
      +  (+27/-7) · 3 Files · 2/3 Approved · PATCH FAILED
       
        ... (Navigator) ...
        ──────────────────────────────────────────────────────────────────────────────
    patchStrategy: replace
snapshot:
  '-   **Behavior:** The UI instantly recalculates. The file icon changes to `[✗]`, and the global stats in the navigator (`0/0`, `0/3 Files`) reflect the new reality. The footer updates as there are no longer any approved files to commit.': null
  '-   **Behavior:** A blocking modal appears, presenting four distinct repair strategies that will apply to all failed files simultaneously.': null
  src/hooks/useReviewScreen.tsx: >-
    import { useMemo } from 'react';

    import { useInput, type Key } from 'ink';

    import { useReviewStore } from '../stores/review.store';

    import { useAppStore } from '../stores/app.store';

    import { useCopyStore } from '../stores/copy.store';

    import { useTransactionStore, selectSelectedTransaction } from
    '../stores/transaction.store';

    import type { FileItem } from '../types/domain.types';


    type NavigableItem =
        | { type: 'prompt' }
        | { type: 'reasoning' }
        | { type: 'script'; id: string }
        | { type: 'file'; id: string };

    export const useReviewScreen = () => {
        const store = useReviewStore();
        const {
            selectedItemIndex,
            bodyView,
            patchStatus,
            selectedBulkRepairOptionIndex,
        } = store;

        const transaction = useTransactionStore(selectSelectedTransaction);
        const { showDashboardScreen } = useAppStore(s => s.actions);

        const navigableItems = useMemo((): NavigableItem[] => {
            if (!transaction) return [];
            const scriptItems: NavigableItem[] = (transaction.scripts || []).map(s => ({ type: 'script', id: s.command }));
            const fileItems: NavigableItem[] = (transaction.files || []).map(f => ({ type: 'file', id: f.id }));
            return [{ type: 'prompt' }, { type: 'reasoning' }, ...scriptItems, ...fileItems];
        }, [transaction]);

        // Memoize files to prevent re-renders, fixing the exhaustive-deps lint warning.
        const files: FileItem[] = useMemo(() => transaction?.files || [], [transaction]);
        const fileReviewStates = useReviewStore(s => s.fileReviewStates);

        const reviewStats = useMemo(() => {
            const approvedFiles = files.filter(f => fileReviewStates.get(f.id)?.status === 'APPROVED');
            return {
                totalFiles: files.length,
                totalLinesAdded: files.reduce((sum, f) => sum + f.linesAdded, 0),
                totalLinesRemoved: files.reduce((sum, f) => sum + f.linesRemoved, 0),
                numFiles: files.length,
                approvedFilesCount: approvedFiles.length,
                approvedLinesAdded: approvedFiles.reduce((sum, f) => sum + f.linesAdded, 0),
                approvedLinesRemoved: approvedFiles.reduce((sum, f) => sum + f.linesRemoved, 0),
            };
        }, [files, fileReviewStates]);

        const { approvedFilesCount } = reviewStats;

        const isFileSelected = navigableItems[selectedItemIndex]?.type === 'file';

        const scripts = transaction?.scripts || [];

        const {
            moveSelectionUp,
            moveSelectionDown,
            expandDiff,
            toggleBodyView,
            setBodyView,
            startApplySimulation,
            approve,
            tryRepairFile,
            showBulkRepair,
            executeBulkRepairOption,
            confirmHandoff,
            scrollReasoningUp,
            scrollReasoningDown,
            navigateScriptErrorUp,
            navigateScriptErrorDown,
            toggleFileApproval,
            rejectAllFiles,
            navigateBulkRepairUp,
            navigateBulkRepairDown,
        } = store.actions;

        const openCopyMode = () => {
            if (!transaction) return;
            const currentItem = navigableItems[selectedItemIndex];
            const selectedFile = currentItem?.type === 'file' ? files.find(f => f.id === currentItem.id) : undefined;
            useCopyStore.getState().actions.openForReview(transaction, transaction.files || [], selectedFile);
        };

        // --- Input Handlers ---

        const handleGlobalInput = (input: string, key: Key): boolean => {
            if (input === '1') { // For demo purposes
                startApplySimulation('success'); return true;
            }
            if (input === '2') { // For demo purposes
                startApplySimulation('failure'); return true;
            }
            // The 'q' (quit/back) is now handled by the global hotkey hook.

            if (key.escape) {
                if (bodyView === 'bulk_repair' || bodyView === 'confirm_handoff') {
                    toggleBodyView(bodyView);
                } else if (bodyView !== 'none') {
                    setBodyView('none');
                }
                return true;
            }
            return false;
        };

        const handleHandoffConfirmInput = (_input: string, key: Key): void => {
            if (key.return) confirmHandoff();
        };

        const handleBulkRepairInput = (input: string, key: Key): void => {
            if (key.upArrow) navigateBulkRepairUp();
            if (key.downArrow) navigateBulkRepairDown();
            if (key.return) {
                executeBulkRepairOption(selectedBulkRepairOptionIndex + 1); // Options are 1-based
                return;
            }

            if (input >= '1' && input <= '4') {
                executeBulkRepairOption(parseInt(input));
            }
        };

        const handleReasoningInput = (input: string, key: Key): void => {
            if (key.upArrow) scrollReasoningUp();
            if (key.downArrow) scrollReasoningDown();
            if (input.toLowerCase() === 'r') toggleBodyView('reasoning');
        };

        const handleScriptOutputInput = (input: string, key: Key): void => {
            if (input.toLowerCase() === 'j') navigateScriptErrorDown();
            if (input.toLowerCase() === 'k') navigateScriptErrorUp();
            if (key.return) toggleBodyView('script_output');
            if (input.toLowerCase() === 'c') { // TODO: this copy logic is not great.
                const currentItem = navigableItems[selectedItemIndex];
                const selectedScript = currentItem?.type === 'script' ? scripts.find(s => s.command === currentItem.id) : undefined;
                if (selectedScript) {
                    // eslint-disable-next-line no-console
                    console.log(`[CLIPBOARD] Copied script output: ${selectedScript.command}`);
                }
            }
        };

        const handleDiffInput = (input: string) => {
            if (input.toLowerCase() === 'x') expandDiff();
            if (input.toLowerCase() === 'd') toggleBodyView('diff');
        };

        const handleMainNavigationInput = (input: string, key: Key): void => {
            // Handle Shift+R for reject all
            if (key.shift && input.toLowerCase() === 'r') {
                if (approvedFilesCount > 0 && transaction) {
                    rejectAllFiles();
                }
                return;
            }

            // Main View Navigation
            if (key.upArrow) moveSelectionUp(navigableItems.length);
            if (key.downArrow) moveSelectionDown(navigableItems.length);

            const currentItem = navigableItems[selectedItemIndex];

            if (input === ' ') {
                if (currentItem?.type === 'file') {
                    const fileState = fileReviewStates.get(currentItem.id);
                    if (fileState && fileState.status !== 'FAILED') {
                        toggleFileApproval(currentItem.id);
                    }
                }
            }

            if (input.toLowerCase() === 'd' && currentItem?.type === 'file') {
                toggleBodyView('diff');
            }

            if (input.toLowerCase() === 'r') {
                toggleBodyView('reasoning');
            }

            if (key.return) { // Enter key
                if (currentItem?.type === 'file') {
                    toggleBodyView('diff');
                } else if (currentItem?.type === 'reasoning') {
                    toggleBodyView('reasoning');
                } else if (currentItem?.type === 'script') {
                    toggleBodyView('script_output');
                }
            }

            if (input.toLowerCase() === 'a') {
                if (approvedFilesCount > 0) {
                    approve();
                    showDashboardScreen();
                }
            }

            if (input.toLowerCase() === 'c') {
                openCopyMode();
            }

            if (input.toLowerCase() === 't') {
                if (key.shift) { // Bulk repair
                    const hasFailedFiles = Array.from(fileReviewStates.values()).some(s => s.status === 'FAILED');
                    if (hasFailedFiles) showBulkRepair();
                } else {
                    if (currentItem?.type === 'file') {
                        const fileState = fileReviewStates.get(currentItem.id);
                        if (fileState?.status === 'FAILED') tryRepairFile(currentItem.id);
                    }
                }
            }
        };

        useInput((input: string, key: Key) => {
            if (handleGlobalInput(input, key)) {
                return;
            }

            switch (bodyView) {
                case 'confirm_handoff': return handleHandoffConfirmInput(input, key);
                case 'bulk_repair': return handleBulkRepairInput(input, key);
                case 'reasoning': return handleReasoningInput(input, key);
                case 'script_output': return handleScriptOutputInput(input, key);
                case 'diff': return handleDiffInput(input);
                default: return handleMainNavigationInput(input, key);
            }
        });

        return {
            ...store,
            fileReviewStates,
            selectedItemIndex,
            transaction,
            files,
            scripts,
            patchStatus,
            navigableItems,
            isFileSelected,
            selectedBulkRepairOptionIndex,
            ...reviewStats,
        };
    };
  src/components/ReviewScreen.tsx: >-
    import { Box, Text } from 'ink';

    import Separator from './Separator';

    import DiffScreen from './DiffScreen';

    import ReasonScreen from './ReasonScreen';

    import type { ScriptResult, FileItem, FileChangeType } from
    '../types/domain.types';

    import { useReviewScreen } from '../hooks/useReviewScreen';


    // --- Sub-components ---


    const FileItemRow = ({ file, reviewStatus, reviewError, isFocused }: {
        file: FileItem;
        reviewStatus: string;
        reviewError?: string;
        isFocused: boolean;
    }) => {
        let icon;
        let iconColor;
        switch (reviewStatus) {
            case 'APPROVED': icon = '[✓]'; iconColor = 'green'; break;
            case 'REJECTED': icon = '[✗]'; iconColor = 'red'; break;
            case 'FAILED': icon = '[!]'; iconColor = 'red'; break;
            case 'AWAITING': icon = '[●]'; iconColor = 'yellow'; break;
            case 'RE_APPLYING': icon = '[●]'; iconColor = 'cyan'; break;
        }

        const typeColor = (type: FileChangeType) => {
            switch (type) {
                case 'ADD': return 'green';
                case 'DEL': return 'red';
                case 'REN': return 'yellow';
                default: return 'white';
            }
        };

        const diffStats = <Text>(+<Text color="green">{file.linesAdded}</Text>/-<Text color="red">{file.linesRemoved}</Text>)</Text>;
        const strategy = file.strategy === 'standard-diff' ? 'diff' : file.strategy;
        const prefix = isFocused ? '> ' : '  ';
        const colorProps = isFocused ? { bold: true, color: 'cyan' } : {};

        if (reviewStatus === 'FAILED') {
            return (
                <Box>
                    <Text {...colorProps}>
                        {prefix}<Text color={iconColor}>{icon} FAILED {file.path}</Text>
                        <Text color="red">    ({reviewError})</Text>
                    </Text>
                </Box>
            );
        }

        if (reviewStatus === 'AWAITING') {
            return (
                <Box>
                    <Text {...colorProps}>
                        {prefix}<Text color={iconColor}>{icon} AWAITING {file.path}</Text>
                        <Text color="yellow">    (Bulk re-apply prompt copied!)</Text>
                    </Text>
                </Box>
            );
        }

        if (reviewStatus === 'RE_APPLYING') {
            return (
                 <Box>
                    <Text {...colorProps}>
                        {prefix}<Text color={iconColor}>{icon} RE-APPLYING... {file.path}</Text>
                        <Text color="cyan"> (using &apos;replace&apos; strategy)</Text>
                    </Text>
                </Box>
            );
        }

        return (
            <Box>
                <Text {...colorProps}>
                    {prefix}<Text color={iconColor}>{icon}</Text> {file.type}{' '}
                    <Text color={typeColor(file.type)}>{file.path}</Text>{' '}
                    {diffStats} [{strategy}]
                </Text>
            </Box>
        );
    };


    const ScriptItemRow = ({
        script,
        isSelected,
        isExpanded,
    }: {
        script: ScriptResult;
        isSelected: boolean;
        isExpanded: boolean;
    }) => {
        const icon = script.success ? '✓' : '✗';
        const iconColor = script.success ? 'green' : 'red';
        const arrow = isExpanded ? '▾' : '▸';
        const prefix = isSelected ? '> ' : '  ';
        
        // Extract script type from command (e.g., "bun run test" -> "Post-Command", "bun run lint" -> "Linter")
        const scriptType = script.command.includes('test') ? 'Post-Command' : 
                          script.command.includes('lint') ? 'Linter' : 
                          'Script';

        return (
            <Box>
                <Text bold={isSelected} color={isSelected ? 'cyan' : undefined}>
                    {prefix}<Text color={iconColor}>{icon}</Text> {scriptType}: `{script.command}` ({script.duration}s) {arrow}{' '}
                    {script.summary}
                </Text>
            </Box>
        );
    };


    // --- Main Component ---


    const ReviewScreen = () => {
        const {
            transaction,
            files,
            scripts = [],
            patchStatus,
            selectedItemIndex,
            bodyView,
            isDiffExpanded,
            reasoningScrollIndex,
            scriptErrorIndex,
            fileReviewStates,
            numFiles,
            approvedFilesCount,
            totalLinesAdded,
            totalLinesRemoved,
            approvedLinesAdded,
            selectedBulkRepairOptionIndex,
        } = useReviewScreen();

        if (!transaction) {
            return <Text>Loading review...</Text>;
        }
        const { hash, message, prompt = '', reasoning = '' } = transaction;

        const renderBody = () => {
            if (bodyView === 'none') return null;

            if (bodyView === 'reasoning') {
                const reasoningText = reasoning || '';
                const reasoningLinesCount = reasoningText.split('\n').length;
                const visibleLinesCount = 10;
                return (
                    <Box flexDirection="column">
                        <ReasonScreen
                            reasoning={reasoningText}
                            scrollIndex={reasoningScrollIndex}
                            visibleLinesCount={visibleLinesCount}
                        />
                        {reasoningLinesCount > visibleLinesCount && (
                            <Text color="gray">
                                Showing lines {reasoningScrollIndex + 1}-{Math.min(reasoningScrollIndex + visibleLinesCount, reasoningLinesCount)}{' '}
                                of {reasoningLinesCount}
                            </Text>
                        )}
                    </Box>
                );
            }
            
            if (bodyView === 'diff') {
                const currentItem = navigableItems[selectedItemIndex];
                const selectedFile = currentItem?.type === 'file' ? files.find(f => f.id === currentItem.id) : undefined;
                if (!selectedFile) return null;
                return (
                    <DiffScreen
                        filePath={selectedFile.path}
                        diffContent={selectedFile.diff}
                        isExpanded={isDiffExpanded}
                    />
                );
            }

            if (bodyView === 'script_output') {
                 const currentItem = navigableItems[selectedItemIndex];
                 const scriptIndex = currentItem?.type === 'script' ? navigableItems.filter(i => i.type === 'script').findIndex(i => i.id === currentItem.id) : -1;
                 const selectedScript = scripts[scriptIndex] || null;
                 if (!selectedScript) return null;
                 
                 const outputLines = selectedScript.output.split('\n');
                 const errorLines = outputLines.filter((line: string) =>
                    line.includes('Error') || line.includes('Warning'),
                 );
                 
                 return (
                    <Box flexDirection="column">
                        <Text>{selectedScript.command.includes('lint') ? 'LINTER' : 'SCRIPT'} OUTPUT: `{selectedScript.command}`</Text>
                        <Box marginTop={1} flexDirection="column">
                            {outputLines.map((line: string, index: number) => {
                                const isError = line.includes('Error');
                                const isWarning = line.includes('Warning');
                                const isHighlighted = errorLines[scriptErrorIndex] === line;
                                
                                return (
                                    <Text 
                                        key={index} 
                                        color={isError ? 'red' : isWarning ? 'yellow' : undefined}
                                        bold={isHighlighted}
                                        backgroundColor={isHighlighted ? 'blue' : undefined}
                                    >
                                        {line}
                                    </Text>
                                );
                            })}
                        </Box>
                        {errorLines.length > 0 && (
                            <Text color="gray">
                                Error {scriptErrorIndex + 1} of {errorLines.length} highlighted
                            </Text>
                        )}
                    </Box>
                 );
            }

            if (bodyView === 'confirm_handoff') {
                return (
                    <Box flexDirection="column" gap={1}>
                        <Text bold>HANDOFF TO EXTERNAL AGENT</Text>
                        <Box flexDirection="column">
                            <Text>This action will:</Text>
                            <Text>1. Copy a detailed prompt to your clipboard for an agentic AI.</Text>
                            <Text>2. Mark the current transaction as &apos;Handoff&apos; and close this review.</Text>
                            <Text>3. Assume that you and the external agent will complete the work.</Text>
                        </Box>
                        <Text>Relaycode will NOT wait for a new patch. This is a final action.</Text>
                        <Text bold color="yellow">Are you sure you want to proceed?</Text>
                    </Box>
                );
            }

            if (bodyView === 'bulk_repair') {
                const failedFiles = files.filter((f: FileItem) => fileReviewStates.get(f.id)?.status === 'FAILED');
                const repairOptions = [
                    '(1) Copy Bulk Re-apply Prompt (for single-shot AI)',
                    '(2) Bulk Change Strategy & Re-apply',
                    '(3) Handoff to External Agent',
                    '(4) Bulk Abandon All Failed Files',
                    '(Esc) Cancel',
                ];

                return (
                    <Box flexDirection="column" gap={1}>
                        <Text bold>BULK REPAIR ACTION</Text>

                        <Box flexDirection="column">
                            <Text>The following {failedFiles.length} files failed to apply:</Text>
                            {failedFiles.map((file: FileItem) => (
                                <Text key={file.id}>- {file.path}</Text>
                            ))}
                        </Box>

                        <Text>How would you like to proceed?</Text>

                        <Box flexDirection="column">
                            {repairOptions.map((opt, i) => (
                                <Text key={i} color={selectedBulkRepairOptionIndex === i ? 'cyan' : undefined}>
                                    {selectedBulkRepairOptionIndex === i ? '> ' : '  '}
                                    {opt}
                                </Text>
                            ))}
                        </Box>
                    </Box>
                );
            }

            return null;
        };

        const renderFooter = () => {
            // Contextual footer for body views
            if (bodyView === 'diff') {
                return <Text>(↑↓) Nav · (X)pand · (D/Esc) Back</Text>;
            }
            if (bodyView === 'reasoning') {
                return <Text>(↑↓) Scroll Text · (R)Collapse View · (C)opy Mode</Text>;
            }
            if (bodyView === 'script_output') {
                return (
                    <Text>(↑↓) Nav · (J↓/K↑) Next/Prev Error · (C)opy Output · (Ent/Esc) Back</Text>
                );
            }
            if (bodyView === 'bulk_repair') {
                return <Text>Choose an option [1-4, Esc]:</Text>;
            }
            if (bodyView === 'confirm_handoff') {
                return <Text>(Enter) Confirm Handoff      (Esc) Cancel</Text>;
            }

            // Main footer
            const actions = ['(↑↓) Nav'];

            const currentItem = navigableItems[selectedItemIndex];
            const hasFailedFiles = Array.from(fileReviewStates.values()).some(s => s.status === 'FAILED');
            
            if (currentItem?.type === 'file') {
                const selectedFile = files.find(f => f.id === currentItem.id);
                const fileState = fileReviewStates.get(currentItem.id);
                if (fileState?.status !== 'FAILED') {
                    actions.push('(Spc) Toggle');
                }
                actions.push('(D)iff');
                
                // Add repair options for failed files
                if (selectedFile && fileState?.status === 'FAILED') {
                    actions.push('(T)ry Repair');
                }
            } else if (currentItem?.type === 'script') {
                actions.push('(Ent) Expand Details');
            } else { // Prompt or Reasoning
                actions.push('(Ent) Expand');
            }

            if (currentItem?.type !== 'reasoning') {
                actions.push('(R)easoning');
            }

            // Add bulk repair if there are failed files
            if (hasFailedFiles) {
                actions.push('(Shift+T) Bulk Repair');
            }
            
            actions.push('(C)opy');

            if (approvedFilesCount > 0) {
                actions.push('(A)pprove');
            }

            if (Array.from(fileReviewStates.values()).some(s => s.status === 'APPROVED' || s.status === 'FAILED')) {
                actions.push('(Shift+R) Reject All');
            }
            actions.push('(Q)uit');

            return <Text>{actions.join(' · ')}</Text>;
        };

        return (
            <Box flexDirection="column">
                {/* Header */}
                <Text color="cyan">▲ relaycode review</Text>
                <Separator />
                
                {/* Navigator Section */}
                <Box flexDirection="column" marginY={1}>
                    <Box flexDirection="column">
                        <Text>{hash} · {message}</Text>
                        <Text>
                            (<Text color="green">+{totalLinesAdded}</Text>/<Text color="red">-{totalLinesRemoved}</Text>) · {numFiles} Files · {approvedFilesCount}/{numFiles} Approved
                            {patchStatus === 'PARTIAL_FAILURE' && scripts.length === 0 && <Text> · Scripts: SKIPPED</Text>}
                            {patchStatus === 'PARTIAL_FAILURE' && <Text color="red" bold> · MULTIPLE PATCHES FAILED</Text>}
                        </Text>
                    </Box>

                    <Box flexDirection="column" marginTop={1}>
                        <Text color={navigableItems[selectedItemIndex]?.type === 'prompt' ? 'cyan' : undefined}>
                            {navigableItems[selectedItemIndex]?.type === 'prompt' ? '> ' : '  '}
                            (P)rompt ▸ {(prompt || '').substring(0, 60)}...
                        </Text>
                        <Text color={navigableItems[selectedItemIndex]?.type === 'reasoning' ? 'cyan' : undefined}>
                            {navigableItems[selectedItemIndex]?.type === 'reasoning' ? '> ' : '  '}
                            (R)easoning ({(reasoning || '').split('\n\n').length} steps) {bodyView === 'reasoning' ? '▾' : '▸'}{' '}
                            {((reasoning || '').split('\n')[0] ?? '').substring(0, 50)}...
                        </Text>
                    </Box>
                </Box>

                <Separator />

                {/* Script Results (if any) */}
                {scripts.length > 0 && navigableItems.some(i => i.type === 'script') && (
                    <>
                        <Box flexDirection="column" marginY={1}>
                            {scripts.map((script: ScriptResult) => (
                                (() => {
                                    const navItemIndex = navigableItems.findIndex(i => i.type === 'script' && i.id === script.command);
                                    const isSelected = selectedItemIndex === navItemIndex;
                                    return (
                                        <ScriptItemRow
                                            key={script.command}
                                            script={script}
                                            isSelected={isSelected}
                                            isExpanded={bodyView === 'script_output' && isSelected}
                                        />
                                    );
                                })()
                            ))}
                        </Box>
                        <Separator />
                    </>
                )}

                {/* Files Section */}
                <Box flexDirection="column" marginY={1}>
                    <Text bold>FILES</Text>
                    {files.map((file: FileItem) => {
                        const navItemIndex = navigableItems.findIndex(i => i.type === 'file' && i.id === file.id);
                        const isFocused = selectedItemIndex === navItemIndex;
                        const reviewState = fileReviewStates.get(file.id);
                        return (
                            <FileItemRow
                                key={file.id}
                                file={file}
                                isFocused={isFocused}
                                reviewStatus={reviewState?.status || 'AWAITING'}
                                reviewError={reviewState?.error}
                            />
                        );
                    })}
                </Box>
                
                <Separator />
                
                {/* Body Viewport */}
                {bodyView !== 'none' && (
                    <>
                        <Box marginY={1}>
                            {renderBody()}
                        </Box>
                        <Separator />
                    </>
                )}

                {/* Footer */}
                <Box>
                    {renderFooter()}
                </Box>
            </Box>
        );
    };


    export default ReviewScreen;
  src/stores/review.store.ts: >-
    import { create } from 'zustand';

    import { useAppStore } from './app.store';

    import { useTransactionStore } from './transaction.store';

    import { useViewStore } from './view.store';

    import { ReviewService } from '../services/review.service';

    import { moveIndex } from './navigation.utils';

    import { INITIAL_APPLY_STEPS } from '../constants/review.constants';

    import type { FileReviewStatus } from '../types/domain.types';


    export interface ApplyStep {
        id: string;
        title: string;
        status: 'pending' | 'active' | 'done' | 'failed' | 'skipped';
        details?: string;
        substeps?: ApplyStep[];
        duration?: number;
    }

    export type ReviewBodyView = 'diff' | 'reasoning' | 'script_output' |
    'bulk_repair' | 'confirm_handoff' | 'none';

    export type PatchStatus = 'SUCCESS' | 'PARTIAL_FAILURE';

    export type ApplyUpdate =
        | { type: 'UPDATE_STEP'; payload: { id: string; status: ApplyStep['status']; duration?: number; details?: string } }
        | { type: 'ADD_SUBSTEP'; payload: { parentId: string; substep: Omit<ApplyStep, 'substeps'> } };

    interface ReviewState {
        patchStatus: PatchStatus;
        applySteps: ApplyStep[];
        selectedItemIndex: number;
        bodyView: ReviewBodyView;
        isDiffExpanded: boolean;
        reasoningScrollIndex: number;
        scriptErrorIndex: number;
        fileReviewStates: Map<string, { status: FileReviewStatus; error?: string }>;

        selectedBulkRepairOptionIndex: number;

        actions: {
            load: (transactionId: string, initialState?: Partial<Pick<ReviewState, 'bodyView' | 'selectedBulkRepairOptionIndex'>>) => void;
            moveSelectionUp: (listSize: number) => void;
            moveSelectionDown: (listSize: number) => void;
            expandDiff: () => void;
            toggleBodyView: (view: Extract<
                ReviewBodyView,
                'diff' | 'reasoning' | 'script_output' | 'bulk_repair' | 'confirm_handoff'
            >) => void;
            setBodyView: (view: ReviewBodyView) => void;
            approve: () => void;
            startApplySimulation: (scenario: 'success' | 'failure') => void;
            tryRepairFile: (fileId: string) => void;
            showBulkRepair: () => void;
            executeBulkRepairOption: (option: number) => Promise<void>;
            confirmHandoff: () => void;
            scrollReasoningUp: () => void;
            scrollReasoningDown: () => void;
            navigateScriptErrorUp: () => void;
            navigateScriptErrorDown: () => void;
            updateApplyStep: (id: string, status: ApplyStep['status'], duration?: number, details?: string) => void;
            addApplySubstep: (parentId: string, substep: Omit<ApplyStep, 'substeps'>) => void;
            updateFileReviewStatus: (fileId: string, status: FileReviewStatus, error?: string) => void;
            toggleFileApproval: (fileId: string) => void;
            rejectAllFiles: () => void;
            navigateBulkRepairUp: () => void;
            navigateBulkRepairDown: () => void;
        };
    }


    export const useReviewStore = create<ReviewState>((set, get) => ({
        patchStatus: 'SUCCESS',
        applySteps: INITIAL_APPLY_STEPS,
        selectedItemIndex: 0,
        bodyView: 'none',
        isDiffExpanded: false,
        reasoningScrollIndex: 0,
        scriptErrorIndex: 0,
        fileReviewStates: new Map(),
        selectedBulkRepairOptionIndex: 0,

        actions: {
            load: (transactionId, initialState) => {
                const transaction = useTransactionStore.getState().transactions.find(t => t.id === transactionId);
                if (!transaction) return;
                
                const { patchStatus, fileReviewStates } = ReviewService.prepareTransactionForReview(transaction);

                useViewStore.getState().actions.setSelectedTransactionId(transaction.id);
                set({
                    patchStatus,
                    fileReviewStates,
                    selectedItemIndex: 0,
                    bodyView: initialState?.bodyView ?? 'none',
                    isDiffExpanded: false,
                    reasoningScrollIndex: 0,
                    scriptErrorIndex: 0,
                    applySteps: JSON.parse(JSON.stringify(INITIAL_APPLY_STEPS)),
                    selectedBulkRepairOptionIndex: 0,
                    ...initialState,
                });
            },
            moveSelectionUp: (listSize) => set(state => {
                return { selectedItemIndex: moveIndex(state.selectedItemIndex, 'up', listSize) };
            }),
            moveSelectionDown: (listSize) => set(state => {
                return { selectedItemIndex: moveIndex(state.selectedItemIndex, 'down', listSize) };
            }),
            toggleBodyView: (view) => set(state => {
                const transactionId = useViewStore.getState().selectedTransactionId;
                const tx = useTransactionStore.getState().transactions.find(t => t.id === transactionId);
                const files = tx?.files || [];
                if (view === 'diff' && state.selectedItemIndex >= files.length) return {};
                return {
                    bodyView: state.bodyView === view ? 'none' : view,
                    isDiffExpanded: false,
                };
            }),
            setBodyView: (view) => set({ bodyView: view }),
            expandDiff: () => set(state => ({ isDiffExpanded: !state.isDiffExpanded })),
            approve: () => {
                const { selectedTransactionId } = useViewStore.getState();
                if (selectedTransactionId) {
                    useTransactionStore.getState().actions.updateTransactionStatus(selectedTransactionId, 'APPLIED');
                    useAppStore.getState().actions.showDashboardScreen();
                }
            },
            startApplySimulation: async (scenario) => {
                const { showReviewProcessingScreen } = useAppStore.getState().actions;
                const { updateApplyStep, addApplySubstep } = get().actions;
                set({ applySteps: JSON.parse(JSON.stringify(INITIAL_APPLY_STEPS)) });
                showReviewProcessingScreen();
                const simulationGenerator = ReviewService.runApplySimulation(scenario);
                for await (const update of simulationGenerator) {
                    if (update.type === 'UPDATE_STEP') {
                        updateApplyStep(
                            update.payload.id,
                            update.payload.status,
                            update.payload.duration,
                            update.payload.details,
                        );
                    } else if (update.type === 'ADD_SUBSTEP') {
                        addApplySubstep(update.payload.parentId, update.payload.substep);
                    }
                }
                // Transition back to review screen is handled by the processing screen component or a separate flow
                // For this simulation, we'll assume it transitions back, but the action itself doesn't need to do it.
                // This avoids a direct dependency from the store to app-level navigation.
            },
            tryRepairFile: (fileId) => {
                const selectedTransactionId = useViewStore.getState().selectedTransactionId;
                const { fileReviewStates } = get();
                if (!selectedTransactionId) return;
                const tx = useTransactionStore.getState().transactions.find(t => t.id === selectedTransactionId);
                const file = tx?.files?.find(f => f.id === fileId);
                if (!file) return;

                const { status, error } = fileReviewStates.get(file.id) || {};
                if (status !== 'FAILED') return;
                
                ReviewService.tryRepairFile(file, error);
                get().actions.updateFileReviewStatus(file.id, 'AWAITING');
            },
            showBulkRepair: () => get().actions.toggleBodyView('bulk_repair'),
            executeBulkRepairOption: async (option) => {
                const selectedTransactionId = useViewStore.getState().selectedTransactionId;
                const tx = useTransactionStore.getState().transactions.find(t => t.id === selectedTransactionId);
                if (!tx?.files) return;

                const failedFiles = tx.files.filter(f => get().fileReviewStates.get(f.id)?.status === 'FAILED');
                if (failedFiles.length === 0) {
                    set({ bodyView: 'none' });
                    return;
                }

                switch (option) {
                    case 1:
                        ReviewService.generateBulkRepairPrompt(failedFiles);
                        set({ bodyView: 'none' });
                        break;
                    case 2: {
                        set({ bodyView: 'none' });
                        failedFiles.forEach(f => get().actions.updateFileReviewStatus(f.id, 'RE_APPLYING'));
                        const results = await ReviewService.runBulkReapply(failedFiles);
                        results.forEach(result =>
                            get().actions.updateFileReviewStatus(
                                result.id, result.status, result.error,
                            ),
                        );
                        break;
                    }
                    case 3:
                        get().actions.setBodyView('confirm_handoff');
                        break;
                    case 4:
                        failedFiles.forEach(file => {
                            get().actions.updateFileReviewStatus(file.id, 'REJECTED');
                        });
                        set({ bodyView: 'none' });
                        break;
                    default:
                        set({ bodyView: 'none' });
                }
            },
            confirmHandoff: () => {
                const transactionId = useViewStore.getState().selectedTransactionId;
                const tx = useTransactionStore.getState().transactions.find(t => t.id === transactionId);
                if (!tx?.files) return;
                const { fileReviewStates } = get();
                ReviewService.generateHandoffPrompt(tx, fileReviewStates);
                ReviewService.performHandoff(tx.hash);
            },
            scrollReasoningUp: () => set(state => ({ reasoningScrollIndex: Math.max(0, state.reasoningScrollIndex - 1) })),
            scrollReasoningDown: () => set(state => {
                const transactionId = useViewStore.getState().selectedTransactionId;
                const tx = useTransactionStore.getState().transactions.find(t => t.id === transactionId);
                if (!tx?.reasoning) return {};
                const maxLines = tx.reasoning.split('\n').length;
                return { reasoningScrollIndex: Math.min(maxLines - 1, state.reasoningScrollIndex + 1) };
            }),
            navigateScriptErrorUp: () => set(state => ({ scriptErrorIndex: Math.max(0, state.scriptErrorIndex - 1) })),
            navigateScriptErrorDown: () => set(state => {
                const transactionId = useViewStore.getState().selectedTransactionId;
                const tx = useTransactionStore.getState().transactions.find(t => t.id === transactionId);
                if (!tx?.scripts || !tx?.files) return {};
                const selectedScript = tx.scripts[state.selectedItemIndex - tx.files.length];
                if (selectedScript?.output) {
                    const errorLines = selectedScript.output
                        .split('\n')
                        .filter(line => line.includes('Error') || line.includes('Warning'));
                    return { scriptErrorIndex: Math.min(errorLines.length - 1, state.scriptErrorIndex + 1) };
                }
                return {};
            }),
            updateApplyStep: (id, status, duration, details) => {
                set(state => ({
                    applySteps: state.applySteps.map(s => {
                        if (s.id === id) {
                            const newStep = { ...s, status };
                            if (duration !== undefined) newStep.duration = duration;
                            if (details !== undefined) newStep.details = details;
                            return newStep;
                        }
                        return s;
                    }),
                }));
            },
            addApplySubstep: (parentId, substep) => {
                set(state => ({
                    applySteps: state.applySteps.map(s => {
                        if (s.id === parentId) {
                            const newSubsteps = [...(s.substeps || []), substep as ApplyStep];
                            return { ...s, substeps: newSubsteps };
                        }
                        return s;
                    }),
                }));
            },
            updateFileReviewStatus: (fileId, status, error) => {
                set(state => {
                    const newStates = new Map(state.fileReviewStates);
                    newStates.set(fileId, { status, error });
                    return { fileReviewStates: newStates };
                });
            },
            toggleFileApproval: (fileId) => {
                set(state => {
                    const newStates = new Map(state.fileReviewStates);
                    const current = newStates.get(fileId);
                    if (current) {
                        const newStatus: FileReviewStatus = current.status === 'APPROVED' ? 'REJECTED' : 'APPROVED';
                        newStates.set(fileId, { status: newStatus, error: undefined });
                    }
                    return { fileReviewStates: newStates };
                });
            },
            rejectAllFiles: () => {
                set(state => {
                    const newStates = new Map(state.fileReviewStates);
                    for (const [fileId, reviewState] of newStates.entries()) {
                        if (reviewState.status === 'APPROVED') {
                            newStates.set(fileId, { status: 'REJECTED', error: undefined });
                        }
                    }
                    return { fileReviewStates: newStates };
                });
            },
            navigateBulkRepairUp: () => set(state => ({
                selectedBulkRepairOptionIndex: moveIndex(state.selectedBulkRepairOptionIndex, 'up', 4),
            })),
            navigateBulkRepairDown: () => set(state => ({
                selectedBulkRepairOptionIndex: moveIndex(state.selectedBulkRepairOptionIndex, 'down', 4),
            })),
        },
    }));
  src/hooks/useDebugMenu.tsx: |-
    import { useState } from 'react';
    import { useInput } from 'ink';
    import { useAppStore } from '../stores/app.store';
    import { useViewStore } from '../stores/view.store';
    import { useDashboardStore } from '../stores/dashboard.store';
    import { useReviewStore } from '../stores/review.store';
    import { useDetailStore } from '../stores/detail.store';
    import { useHistoryStore } from '../stores/history.store';
    import { useInitStore } from '../stores/init.store';
    import { useCommitStore } from '../stores/commit.store';
    import { useCopyStore } from '../stores/copy.store';
    import type { MenuItem } from '../types/debug.types';
    import { useTransactionStore } from '../stores/transaction.store';
    import { moveIndex } from '../stores/navigation.utils';
    export type { MenuItem } from '../types/debug.types';

    const useDebugMenuActions = () => {
        const { actions: appActions } = useAppStore();
        const { actions: initActions } = useInitStore();
        const { actions: commitActions } = useCommitStore();
        const { actions: dashboardActions } = useDashboardStore();
        const { actions: reviewActions } = useReviewStore();
        const { actions: detailActions } = useDetailStore();
        const { actions: historyActions } = useHistoryStore();

        const menuItems: MenuItem[] = [
            {
                title: 'Splash Screen',
                action: () => appActions.showSplashScreen(),
            },
            {
                title: 'Init: Analyze Phase',
                action: () => {
                    initActions.setPhase('ANALYZE');
                    appActions.showInitScreen();
                },
            },
            {
                title: 'Init: Interactive Phase',
                action: () => {
                    initActions.setPhase('INTERACTIVE');
                    appActions.showInitScreen();
                },
            },
            {
                title: 'Init: Finalize Phase',
                action: () => {
                    initActions.setPhase('FINALIZE');
                    appActions.showInitScreen();
                },
            },
            {
                title: 'Dashboard: Listening',
                action: () => {
                    dashboardActions.setStatus('LISTENING');
                    appActions.showDashboardScreen();
                },
            },
            {
                title: 'Dashboard: Confirm Approve',
                action: () => {
                    dashboardActions.startApproveAll();
                    appActions.showDashboardScreen();
                },
            },
            {
                title: 'Dashboard: Approving',
                action: () => {
                    dashboardActions.setStatus('APPROVING');
                    appActions.showDashboardScreen();
                },
            },
            {
                title: 'Review: Partial Failure (Default)',
                action: () => {
                    reviewActions.load('1');
                    appActions.showReviewScreen();
                },
            },
            {
                title: 'Review: Success',
                action: () => {
                    reviewActions.load('2');
                    appActions.showReviewScreen();
                },
            },
            {
                title: 'Review: Diff View',
                action: () => {
                    reviewActions.load('1');
                    reviewActions.setBodyView('diff');
                    appActions.showReviewScreen();
                },
            },
            {
                title: 'Review: Reasoning View',
                action: () => {
                    reviewActions.load('1', { bodyView: 'reasoning' });
                    appActions.showReviewScreen();
                },
            },
            {
                title: 'Review: Copy Mode',
                action: () => {
                    reviewActions.load('1');
                    appActions.showReviewScreen();
                    const tx = useTransactionStore.getState().transactions.find(t => t.id === '1');
                    if (!tx) return;
                    // On load, selected index is 0, so we can assume the first file.
                    const selectedFile = tx.files && tx.files.length > 0
                        ? tx.files[0]
                        : undefined;
                    useCopyStore.getState().actions.openForReview(tx, tx.files || [], selectedFile);
                },
            },
            {
                title: 'Review: Script Output',
                action: () => {
                    reviewActions.load('2');
                    appActions.showReviewScreen();
                    reviewActions.setBodyView('script_output');
                },
            },
            {
                title: 'Review: Bulk Repair',
                action: () => {
                    reviewActions.load('1', { bodyView: 'bulk_repair' });
                    appActions.showReviewScreen();
                },
            },
            {
                title: 'Review: Handoff Confirm',
                action: () => {
                    reviewActions.load('1', { bodyView: 'confirm_handoff' });
                    appActions.showReviewScreen();
                },
            },
            {
                title: 'Review Processing',
                action: () => {
                    reviewActions.load('2'); // Use tx '2' which has scripts
                    appActions.showReviewProcessingScreen();
                },
            },
            {
                title: 'Git Commit Screen',
                action: () => {
                    commitActions.prepareCommitScreen();
                    appActions.showGitCommitScreen();
                },
            },
            {
                title: 'Transaction Detail Screen',
                action: () => {
                    // The dashboard store has transactions, we'll just pick one.
                    detailActions.load('3'); // 'feat: implement new dashboard UI'
                    appActions.showTransactionDetailScreen();
                },
            },
            {
                title: 'Transaction History Screen',
                action: () => {
                    historyActions.load();
                    appActions.showTransactionHistoryScreen();
                },
            },
            {
                title: 'History: L1 Drilldown (Content)',
                action: () => {
                    historyActions.prepareDebugState('l1-drill-content');
                    appActions.showTransactionHistoryScreen();
                },
            },
            {
                title: 'History: L2 Drilldown (Reasoning)',
                action: () => {
                    historyActions.prepareDebugState('l2-drill-reasoning');
                    appActions.showTransactionHistoryScreen();
                },
            },
            {
                title: 'History: L2 Drilldown (File Diff)',
                action: () => {
                    historyActions.prepareDebugState('l2-drill-diff');
                    appActions.showTransactionHistoryScreen();
                },
            },
            {
                title: 'History: Filter Mode',
                action: () => {
                    historyActions.prepareDebugState('filter');
                    appActions.showTransactionHistoryScreen();
                },
            },
            {
                title: 'History: Copy Mode',
                action: () => {
                    historyActions.prepareDebugState('copy');
                    appActions.showTransactionHistoryScreen();
                    const { transactions } = useTransactionStore.getState();
                    const { selectedForAction } = useHistoryStore.getState();
                    const txsToCopy = transactions.filter(tx => selectedForAction.has(tx.id));
                    useCopyStore.getState().actions.openForHistory(txsToCopy);
                },
            },
            {
                title: 'History: Bulk Actions Mode',
                action: () => {
                    historyActions.prepareDebugState('bulk');
                    appActions.showTransactionHistoryScreen();
                },
            },
        ];
        return { menuItems };
    };

    export const useDebugMenu = () => {
        const [selectedIndex, setSelectedIndex] = useState(0);
        const { menuItems } = useDebugMenuActions();
        
        useInput((input, key) => {
            if (key.upArrow) {
                setSelectedIndex(i => moveIndex(i, 'up', menuItems.length));
                return;
            }
            if (key.downArrow) {
                setSelectedIndex(i => moveIndex(i, 'down', menuItems.length));
                return;
            }
            if (key.return) {
                const item = menuItems[selectedIndex];
                if (item) {
                    item.action();
                    useViewStore.getState().actions.setActiveOverlay('none');
                }
                return;
            }
            if (key.escape) {
                useViewStore.getState().actions.setActiveOverlay('none');
                return;
            }

            // No ctrl/meta keys for selection shortcuts, and only single characters
            if (key.ctrl || key.meta || input.length !== 1) return;

            if (input >= '1' && input <= '9') {
                const targetIndex = parseInt(input, 10) - 1;
                if (targetIndex < menuItems.length) {
                    setSelectedIndex(targetIndex);
                }
            } else if (input.toLowerCase() >= 'a' && input.toLowerCase() <= 'z') {
                const targetIndex = 9 + (input.toLowerCase().charCodeAt(0) - 'a'.charCodeAt(0));
                if (targetIndex < menuItems.length) {
                    setSelectedIndex(targetIndex);
                }
            }
        });

        return {
            selectedIndex,
            menuItems,
        };
    };
  docs/relaycode-tui/review-screen.readme.md: >
    # REVIEW-SCREEN.README.MD


    ## Relaycode TUI: The Stateful Apply & Review Screen


    This document specifies the design and behavior of the stateful **Apply &
    Review Screen**. This screen is the interactive core of the Relaycode
    workflow, appearing immediately after a patch has been processed and applied
    to the filesystem. It is a command center for analysis, granular control,
    data extraction, and iterative repair.


    ### 1. Core Philosophy


    The Review screen is not a simple "accept/reject" dialog. It is a strategic
    workspace designed to give the user complete control and insight over
    incoming code changes.


    -   **Information Supremacy:** The UI provides all necessary context at a
    glance: high-level stats, the AI's reasoning, post-script results, the patch
    strategy used per file, and deep-dive diffs. Nothing is hidden.

    -   **Granular Control:** The user is empowered to make decisions on a
    per-file basis. The UI dynamically recalculates and reflects the impact of
    these decisions in real-time.

    -   **Iterative Repair Workflow:** Failure is treated as a temporary state,
    not an endpoint. The UI provides a powerful suite of tools—from AI-driven
    prompts to manual overrides—to handle even complex, multi-file failures
    gracefully.

    -   **Data Accessibility:** Every piece of information (prompts, diffs,
    reasoning, script outputs) is easily copyable, respecting the user's need to
    use this data in other contexts.


    ### 2. UI Layout Components


    1.  **Header:** `▲ relaycode review`.

    2.  **Navigator:** The top section, acting as a command-and-control center.
    It contains the transaction summary, global stats, expandable
    reasoning/prompt, script results, and the file list.

    3.  **Body:** A dynamic viewport that renders detailed content—like diffs or
    script outputs—based on the user's focus in the Navigator.

    4.  **Footer:** The contextual action bar, showing available keyboard
    shortcuts that change constantly based on the UI's state and focus.


    ### 3. The Interactive States & Workflow


    This screen is the interactive workspace that appears after the initial
    patch application is complete (whether successful or not). It allows the
    user to review, repair, and resolve the transaction.


    ---


    #### **State 3.1: Interactive Review (Multi-File Failure)**


    This state appears after a partial failure during the live application
    phase. The screen is now waiting for user intervention.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      e4a7c112 · refactor: rename core utility function
      (+18/-5) · 1/3 Files · 0.6s · Scripts: SKIPPED · MULTIPLE PATCHES FAILED

     (P)rompt ▸ Rename the `calculateChanges` utility to `computeDelta`...
     (R)easoning (2 steps) ▸ 1. Renamed the function in its definition file...
     ──────────────────────────────────────────────────────────────────────────────
     FILES
       [✓] MOD src/core/transaction.ts (+18/-5) [replace]
     > [!] FAILED src/utils/logger.ts    (Hunk #1 failed to apply)
       [!] FAILED src/commands/apply.ts   (Context mismatch at line 92)

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (D)iff · (T)ry Repair · (Shift+T) Bulk Repair · (Shift+R) Reject All · (Esc) Back
    ```

    -   **Behavior:** The header clearly indicates `MULTIPLE PATCHES FAILED`.
    The footer presents both single-file `(T)` and `(Shift+T)` bulk repair
    options.


    ---


    #### **State 3.2: Granular File Rejection & Dynamic Recalculation**


    The user decides one of the successful changes is undesirable and rejects
    it.


    **Trigger:** User navigates to `src/core/transaction.ts` and presses
    `(Space)`.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      e4a7c112 · refactor: rename core utility function
      (0/0) · 0/3 Files · 0.6s · Scripts: SKIPPED · MULTIPLE PATCHES FAILED

     (P)rompt ▸ Rename the `calculateChanges` utility to `computeDelta`...
     (R)easoning (2 steps) ▸ 1. Renamed the function in its definition file...
     ──────────────────────────────────────────────────────────────────────────────
     FILES
     > [✗] MOD src/core/transaction.ts (+18/-5) [replace]
       [!] FAILED src/utils/logger.ts    (Hunk #1 failed to apply)
       [!] FAILED src/commands/apply.ts   (Context mismatch at line 92)

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (Spc) Toggle · (D)iff · (Shift+R) Reject All · (Esc) Back
    ```

    -   **Behavior:** The UI instantly recalculates. The file icon changes to
    `[✗]`, and the global stats in the navigator (`0/0`, `0/3 Files`) reflect
    the new reality. The footer updates as there are no longer any approved
    files to commit.


    ---


    #### **State 3.3: Interactive Review (Success Case with Script Results)**


    This is the state after a fully successful patch application.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      4b9d8f03 · refactor: simplify clipboard logic
      (+22/-11) · 2 Files · 3.9s

     (P)rompt ▸ Simplify the clipboard logic using an external library...
     (R)easoning (3 steps) ▸ 1. Added clipboardy dependency...
     ──────────────────────────────────────────────────────────────────────────────
      ✓ Post-Command: `bun run test` (2.3s) ▸ Passed (37 tests)
      ✗ Linter: `bun run lint` (1.2s) ▸ 1 Error, 3 Warnings
     ──────────────────────────────────────────────────────────────────────────────
     FILES
     > [✓] MOD src/core/clipboard.ts (+15/-8) [replace]
       [✓] MOD src/utils/shell.ts     (+7/-3)  [diff]

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (Spc) Toggle · (D)iff · (Ent) Expand Details · (C)opy · (A)pprove · (Q)uit
    ```

    -   **Behavior:** New, expandable sections appear for each post-application
    script, providing an at-a-glance summary of their results (`✓`/`✗`).


    ---


    #### **State 3.4: Expanding Script Results (Body View)**


    **Trigger:** User navigates to the Linter line and presses `(Enter)`.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      4b9d8f03 · refactor: simplify clipboard logic
      (+22/-11) · 2 Files · 3.9s

     (P)rompt ▸ Simplify the clipboard logic using an external library...
     (R)easoning (3 steps) ▸ 1. Added clipboardy dependency...
     ──────────────────────────────────────────────────────────────────────────────
      ✓ Post-Command: `bun run test` (2.3s) ▸ Passed (37 tests)
    > ✗ Linter: `bun run lint` (1.2s) ▾ 1 Error, 3 Warnings
     ──────────────────────────────────────────────────────────────────────────────
      LINTER OUTPUT: `bun run lint`

      src/core/clipboard.ts
        45:12  Error    'clipboardy' is assigned a value but never used. (@typescript-eslint/no-unused-vars)
        88:5   Warning  Unexpected console statement. (no-console)

      src/utils/shell.ts
        23:9   Warning  'result' is never reassigned. Use 'const' instead. (prefer-const)
        25:1   Warning  Empty block statement. (no-empty)

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (Enter) Collapse · (J↓/K↑) Next/Prev Error · (C)opy Output · (Esc) Back
    ```

    -   **Behavior:** The Body viewport is replaced with the detailed, formatted
    output from the linter. The footer provides contextual navigation hotkeys
    (`J/K`) to jump between errors.


    ---


    #### **State 3.5: Copy Mode**


    **Trigger:** User presses `(C)` from any primary review state.


    ```
     ▲ relaycode review · copy mode
     ──────────────────────────────────────────────────────────────────────────────
     Select item to copy to clipboard:

     > [U] UUID:        e4a7c112-a8b3-4f2c-9d1e-8a7c1b9d8f03
       [M] Git Message: refactor: rename core utility function
       [P] Prompt:      Rename the `calculateChanges` utility to...
       [R] Reasoning:   1. Renamed the function in its definition...
     ──────────────────────────────────────────────────────────────────────────────
       [F] Diff for:    src/core/transaction.ts
       [A] All Diffs (3 files)
     ──────────────────────────────────────────────────────────────────────────────
      ✓ Copied UUID to clipboard.

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (Enter) Copy Selected · (U,M,P,R,F,A) Hotkeys · (C, Esc) Exit
    ```

    -   **Behavior:** A modal overlay appears, allowing the user to copy any
    piece of metadata related to the transaction to their clipboard with single
    keystrokes.


    ### 4. The Advanced Repair Workflow


    ---


    #### **State 4.1: Initiating Bulk Repair**


    **Trigger:** From the multi-failure state (3.1), the user presses
    `(Shift+T)`.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
     ... (Navigator remains the same) ...
     ──────────────────────────────────────────────────────────────────────────────
      BULK REPAIR ACTION

      The following 2 files failed to apply:
      - src/utils/logger.ts
      - src/commands/apply.ts

      How would you like to proceed?

    > (1) Copy Bulk Re-apply Prompt (for single-shot AI)
      (2) Bulk Change Strategy & Re-apply
      (3) Handoff to External Agent
      (4) Bulk Abandon All Failed Files
      (Esc) Cancel

     ──────────────────────────────────────────────────────────────────────────────
     Choose an option [1-4, Esc]:
    ```

    -   **Behavior:** A blocking modal appears, presenting four distinct repair
    strategies that will apply to all failed files simultaneously.


    ---


    #### **Flow 4.2: The "Re-apply Prompt" (AI-driven Repair)**


    **Trigger:** User selects option `(1)`. A detailed prompt is copied to the
    clipboard, and the UI enters a waiting state.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      e4a7c112 · refactor: rename core utility function
      (+18/-5) · 1/3 Files · 0.6s · AWAITING PATCH

     (P)rompt ▸ Rename the `calculateChanges` utility to `computeDelta`...
     (R)easoning (2 steps) ▸ 1. Renamed the function in its definition file...
     ──────────────────────────────────────────────────────────────────────────────
     FILES
       [✓] MOD src/core/transaction.ts    (+18/-5) [replace]
     > [●] AWAITING src/utils/logger.ts    (Bulk re-apply prompt copied!)
       [●] AWAITING src/commands/apply.ts

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (D)iff · (C)opy · (Esc) Abandon & Commit Approved
    ```


    **Generated Prompt (Copied to Clipboard):**

    ```text

    The previous patch failed to apply to MULTIPLE files. Please generate a new,
    corrected patch that addresses all the files listed below.


    IMPORTANT: The response MUST contain a complete code block for EACH file
    that needs to be fixed.


    --- FILE: src/utils/logger.ts ---

    Strategy: standard-diff

    Error: Hunk #1 failed to apply


    ORIGINAL CONTENT:

    ---

    import chalk from 'chalk';

    // ... entire original content of logger.ts ...

    ---


    FAILED PATCH:

    ---

    --- a/src/utils/logger.ts

    +++ b/src/utils/logger.ts

    // ... the failed diff block ...

    ---



    --- FILE: src/commands/apply.ts ---

    Strategy: standard-diff

    Error: Context mismatch at line 92


    ORIGINAL CONTENT:

    ---

    import { applyPatch } from 'relaycode-core';

    // ... entire original content of apply.ts ...

    ---


    FAILED PATCH:

    ---

    --- a/src/commands/apply.ts

    +++ b/src/commands/apply.ts

    // ... the second failed diff block ...

    ---


    Please analyze all failed files and provide a complete, corrected response.

    ```


    ---


    #### **Flow 4.3: The "Change Strategy" (User-driven Repair)**


    **Trigger:** User selects option `(2)` and chooses a new strategy (e.g.,
    `replace`). The system re-applies the original patches with the new
    strategy, providing live feedback.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
     ... (Navigator) ... · BULK RE-APPLYING...
     ──────────────────────────────────────────────────────────────────────────────
     FILES
       [✓] MOD src/core/transaction.ts    (+18/-5) [replace]
     > [●] RE-APPLYING... src/utils/logger.ts (using 'replace' strategy)
       [ ] PENDING...     src/commands/apply.ts

     ──────────────────────────────────────────────────────────────────────────────
     Re-applying failed patches...
    ```


    **Resolution (Mixed Result):**

    The re-application finishes with one success and one failure.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      e4a7c112 · refactor: rename core utility function
      (+27/-7) · 2/3 Files · 0.6s · PATCH FAILED

     ... (Navigator) ...
     ──────────────────────────────────────────────────────────────────────────────
     FILES
       [✓] MOD src/core/transaction.ts    (+18/-5) [replace]
     > [✓] MOD src/utils/logger.ts    (+9/-2) [replace]
       [!] FAILED src/commands/apply.ts   ('replace' failed: markers not found)

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (Spc) Toggle · (T)ry Repair · (C)opy · (Ent) Confirm & Commit
    ```


    ---


    #### **Flow 4.4: The "Handoff" (Agentic Repair)**


    **Trigger:** User selects option `(3)`. A confirmation modal appears first.
    Upon confirmation, a specialized prompt is copied, and the transaction is
    finalized with a `Handoff` status.


    ```
     ▲ relaycode review
     ──────────────────────────────────────────────────────────────────────────────
      HANDOFF TO EXTERNAL AGENT

      This action will:
      1. Copy a detailed prompt to your clipboard for an agentic AI.
      2. Mark the current transaction as 'Handoff' and close this review.
      3. Assume that you and the external agent will complete the work.

      Relaycode will NOT wait for a new patch. This is a final action.

      Are you sure you want to proceed?
     ──────────────────────────────────────────────────────────────────────────────
     (Enter) Confirm Handoff      (Esc) Cancel
    ```


    **Resolution (Dashboard View):**

    After handoff, the user is returned to the dashboard, which now logs the
    action.


    ```
     ▲ relaycode dashboard
     ──────────────────────────────────────────────────────────────────────────────
     STATUS: ● LISTENING · APPROVALS: 00 · COMMITS: 04

      EVENT STREAM (Last 15 minutes)

      > -5s    → HANDOFF   e4a7c112 · refactor: rename core utility function
        -2m    ✓ APPLIED   4b9d8f03 · refactor: simplify clipboard logic
        ...

     ──────────────────────────────────────────────────────────────────────────────
     (↑↓) Nav · (Enter) View Details · (P)ause · (Q)uit
    ```

    -   **Behavior:** A new `→ HANDOFF` icon and status provide a permanent
    record. The transaction is considered "done" by Relaycode's automated
    systems, and responsibility is now with the user and their external agent.


    ### 5. The Handoff Prompt: Design & Specification


    The "Handoff Prompt" is a specialized, machine-generated text block copied
    to the user's clipboard during the Handoff workflow. It is not a simple
    error message; it is a carefully engineered "briefing document" designed to
    transfer the entire context of a failed Relaycode transaction to an
    external, conversational AI assistant (like Claude, GPT-4, or an
    IDE-integrated agent).


    #### Core Design Principles


    1.  **Context is King:** The prompt's primary goal is to eliminate the need
    for the user to manually explain the situation. It must contain the *goal*,
    the *plan*, the *partial results*, and the *failures* of the original
    transaction.

    2.  **Clear Separation of Concerns:** The prompt must unambiguously
    distinguish between what has already been successfully applied to the
    filesystem and what remains broken. This prevents the external agent from
    re-doing completed work.

    3.  **Actionable & Conversational:** It should not be a passive data dump.
    The prompt must end with a clear call to action that initiates a
    collaborative, turn-by-turn repair session.

    4.  **Pointer to the Source of Truth:** For maximum fidelity, it must
    reference the on-disk transaction YAML file. This allows an advanced agent
    (or the user) to consult the original, detailed plan if the summary is
    insufficient.


    ---


    #### Handoff Prompt Template


    This is the template used by Relaycode to generate the prompt. It
    dynamically fills in the placeholders with data from the current failed
    transaction.


    ```text

    I am handing off a failed automated code transaction to you. Your task is to
    act as my programming assistant and complete the planned changes.


    The full plan for this transaction is detailed in the YAML file located at:
    `.relay/transactions/{{TRANSACTION_UUID}}.yml`. Please use this file as your
    primary source of truth for the overall goal.


    Here is the current status of the transaction:


    --- TRANSACTION SUMMARY ---

    Goal: {{GIT_COMMIT_MESSAGE}}

    Reasoning:

    {{AI_REASONING_STEPS}}


    --- CURRENT FILE STATUS ---

    SUCCESSFUL CHANGES (already applied, no action needed):

    {{#each successful_files}}

    - {{operation}}: {{path}}

    {{/each}}


    FAILED CHANGES (these are the files you need to fix):

    {{#each failed_files}}

    - FAILED: {{path}} (Error: {{error_message}})

    {{/each}}


    Your job is to now work with me to fix the FAILED files and achieve the
    original goal of the transaction. Please start by asking me which file you
    should work on first.

    ```


    ---


    #### Concrete Example


    Let's use the multi-file failure scenario from this document.


    -   **Transaction UUID:** `e4a7c112`

    -   **Goal:** `refactor: rename core utility function`

    -   **Reasoning:**
        1.  Renamed the function in its definition file, `src/core/transaction.ts`.
        2.  Attempted to update all call sites for the renamed function.
    -   **Successful Files:**
        -   `MODIFIED: src/core/transaction.ts`
    -   **Failed Files:**
        -   `FAILED: src/utils/logger.ts` (Error: Hunk #1 failed to apply)
        -   `FAILED: src/commands/apply.ts` (Error: Context mismatch at line 92)

    When the user confirms the Handoff action, the following text is copied
    directly to their clipboard:


    ```text

    I am handing off a failed automated code transaction to you. Your task is to
    act as my programming assistant and complete the planned changes.


    The full plan for this transaction is detailed in the YAML file located at:
    `.relay/transactions/e4a7c112.yml`. Please use this file as your primary
    source of truth for the overall goal.


    Here is the current status of the transaction:


    --- TRANSACTION SUMMARY ---

    Goal: refactor: rename core utility function

    Reasoning:

    1. Renamed the function in its definition file, `src/core/transaction.ts`.

    2. Attempted to update all call sites for the renamed function.


    --- CURRENT FILE STATUS ---

    SUCCESSFUL CHANGES (already applied, no action needed):

    - MODIFIED: src/core/transaction.ts


    FAILED CHANGES (these are the files you need to fix):

    - FAILED: src/utils/logger.ts (Error: Hunk #1 failed to apply)

    - FAILED: src/commands/apply.ts (Error: Context mismatch at line 92)


    Your job is to now work with me to fix the FAILED files and achieve the
    original goal of the transaction. Please start by asking me which file you
    should work on first.

    ```
approved: false
linesAdded: null
linesRemoved: null
linesDifference: null
gitCommittedAt: null
status: undone
id: 118
